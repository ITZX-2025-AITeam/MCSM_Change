<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹ç»¼åˆè¯„æµ‹ç³»ç»Ÿ</title>
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: #f6f8fa;
            min-height: 100vh;
            color: #24292f;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #24292f;
            margin-bottom: 30px;
            padding: 40px 0 20px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            color: #24292f;
        }

        .header p {
            font-size: 1.2em;
            color: #656d76;
        }

        .main-panel {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04), 0 1px 0 rgba(255,255,255,0.25);
            padding: 24px;
            margin-bottom: 20px;
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
            background-color: #ffffff;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9,105,218,0.3);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            min-width: 120px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #0969da;
            color: white;
            border-color: #0969da;
        }

        .btn-primary:hover {
            background-color: #0858b9;
            border-color: #0858b9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #cf222e;
            color: white;
            border-color: #cf222e;
        }

        .btn-danger:hover {
            background-color: #a91e2a;
            border-color: #a91e2a;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: #2da44e;
            color: white;
            border-color: #2da44e;
        }

        .btn-success:hover {
            background-color: #2c974b;
            border-color: #2c974b;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-section {
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #24292f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-header h3 {
            color: #24292f;
            margin: 0;
        }

        .progress-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .current-test {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-count {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .progress-step.active:not(:last-child)::after {
            background: #4ade80;
        }

        .progress-step.completed:not(:last-child)::after {
            background: #4ade80;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-icon {
            background: #4ade80;
            transform: scale(1.1);
        }

        .progress-step.completed .step-icon {
            background: #4ade80;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-step.active .step-label {
            color: white;
            font-weight: 600;
        }

        .progress-step.completed .step-label {
            color: white;
            font-weight: 600;
        }

        /* ç»ˆç«¯é£æ ¼è¿›åº¦æ¡ */
        .terminal-progress {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            height: 24px;
            position: relative;
            overflow: hidden;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: #c9d1d9;
        }
        .terminal-progress-fill {
            background: #238636;
            height: 100%;
            width: 0%;
            transition: width 0.1s linear;
        }
        .terminal-progress-label {
            position: absolute;
            left: 8px;
            right: 8px;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #c9d1d9;
            pointer-events: none;
        }

        .status-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.running {
            background: #28a745;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        .output-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #374151;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            border: 1px solid #d1d5db;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .output-line {
            margin-bottom: 5px;
            padding: 2px 0;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .results-section {
            display: none;
            margin-top: 20px;
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            border-left: 4px solid #0969da;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04);
            transition: transform 0.15s ease-in-out;
        }

        .score-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(27,31,36,0.1);
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #0969da;
            margin-bottom: 5px;
        }

        .score-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grade-display {
            background: #0969da;
            color: white;
            border-radius: 6px;
            padding: 24px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #0969da;
        }

        .grade-letter {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .grade-text {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04);
            height: 400px;
            max-height: 400px;
            overflow: hidden;
            position: relative;
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 350px !important;
            width: auto !important;
            height: auto !important;
        }

        .vulnerabilities-section {
            background: #fff8dc;
            border: 1px solid #f0c674;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .vulnerability-item {
            background: white;
            border-left: 4px solid #cf222e;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            word-wrap: break-word;
            max-width: 100%;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .control-section {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .score-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ æ¨¡å‹ç»¼åˆè¯„æµ‹ç³»ç»Ÿ</h1>
            <p>åŸºäº Hugging Face æ ‡å‡†çš„AIæ¨¡å‹é»‘ç®±æµ‹è¯•å¹³å°</p>
        </div>

        <div class="main-panel">
            <div class="control-section">
                <div class="input-group">
                    <label for="target-url">ç›®æ ‡æ¨¡å‹åœ°å€</label>
                    <input type="text" id="target-url" value="192.168.1.101:5001" placeholder="IP:ç«¯å£">
                </div>
                <div class="input-group">
                    <label for="test-mode">æµ‹è¯•æ¨¡å¼</label>
                    <select id="test-mode">
                        <option value="comprehensive">ç»¼åˆæµ‹è¯•</option>
                        <option value="security">å®‰å…¨æ€§ä¸“é¡¹</option>
                        <option value="performance">æ€§èƒ½ä¸“é¡¹</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="start-btn" onclick="startEvaluation()">
                    <span id="start-text">ğŸš€ å¼€å§‹è¯„ä¼°</span>
                    <span id="start-loading" class="loading hidden"></span>
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopEvaluation()" disabled>
                    â¹ï¸ åœæ­¢è¯„ä¼°
                </button>
                <!-- ä¸‹è½½æŒ‰é’®ç§»é™¤ï¼šæŠ¥å‘Šå°†è‡ªåŠ¨ä¿å­˜è‡³ /root/server/MCSManager/report -->
                <button class="btn" style="background-color: #656d76; border-color: #656d76; color: white;" onclick="window.location.href='/offline_test'">
                    ğŸ”§ ç¦»çº¿æµ‹è¯•
                </button>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <h3>ğŸš€ è¯„ä¼°è¿›åº¦</h3>
                </div>
                
                <!-- ç»ˆç«¯é£æ ¼è¿›åº¦æ¡ï¼ˆ0-100%ï¼‰ -->
                <div class="terminal-progress" id="terminal-progress">
                    <div class="terminal-progress-fill" id="terminal-progress-fill"></div>
                    <div class="terminal-progress-label">
                        <span id="terminal-progress-left">0%</span>
                        <span id="terminal-progress-right">[00:00<00:00, 0.00%/s]</span>
                    </div>
                </div>
                
                <!-- è¯¦ç»†æµ‹è¯•è¿›åº¦æ¡ç§»é™¤ï¼šä»…ä¿ç•™æ€»ä½“çº¿æ€§è¿›åº¦æ¡ -->
            </div>

            <div class="status-section">
                <div class="status-header">
                    <h3>ğŸ“Š è¯„ä¼°çŠ¶æ€</h3>
                    <div class="status-indicator">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">å°±ç»ª</span>
                    </div>
                </div>
                <div class="output-container" id="output-container">
                    <div class="output-line" id="initial-message">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…å¼€å§‹è¯„ä¼°...</div>
                </div>
            </div>

            <div class="results-section" id="results-section">
                <div class="grade-display" id="grade-display">
                    <div class="grade-letter" id="grade-letter">-</div>
                    <div class="grade-text" id="grade-text">ç­‰å¾…è¯„ä¼°ç»“æœ</div>
                </div>

                <div class="score-display" id="score-display">
                    <!-- åˆ†æ•°å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="chart-container">
                    <h3>ğŸ“ˆ è¯¦ç»†åˆ†æ</h3>
                    <canvas id="score-chart" width="400" height="200"></canvas>
                </div>

                <div class="vulnerabilities-section" id="vulnerabilities-section">
                    <h3>âš ï¸ å‘ç°çš„é—®é¢˜</h3>
                    <div id="vulnerabilities-list">
                        <!-- æ¼æ´åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¾“å‡ºç»“æŸæ ‡è®°ï¼šæ¯æ¬¡æ–°è¯„ä¼°å¼€å§‹å‰éœ€è¦å¤ä½ä¸º false
        window.__output_finalized__ = false;
        let eventSource = null;
        let isRunning = false;
        let statusCheckInterval = null;

        // é¡µé¢é«˜åº¦ç›‘æ§å’Œæ¸…ç†
        function monitorPageHeight() {
            const body = document.body;
            const maxHeight = window.innerHeight * 5; // æœ€å¤šå…è®¸5ä¸ªå±å¹•é«˜åº¦
            
            if (body.scrollHeight > maxHeight) {
                console.log('é¡µé¢è¿‡é«˜ï¼Œè¿›è¡Œæ¸…ç†');
                
                // æ¸…ç†è¾“å‡ºå®¹å™¨
                const container = document.getElementById('output-container');
                if (container && container.children.length > 10) {
                    const children = Array.from(container.children);
                    const keepCount = 10;
                    for (let i = 0; i < children.length - keepCount; i++) {
                        container.removeChild(children[i]);
                    }
                }
                
                // æ¸…ç†æ¼æ´åˆ—è¡¨
                const vulnList = document.getElementById('vulnerabilities-list');
                if (vulnList && vulnList.children.length > 10) {
                    const children = Array.from(vulnList.children);
                    const keepCount = 10;
                    for (let i = 0; i < children.length - keepCount; i++) {
                        vulnList.removeChild(children[i]);
                    }
                }
                
                // å¼ºåˆ¶å›åˆ°é¡µé¢é¡¶éƒ¨
                window.scrollTo(0, 0);
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // å›å¡«å·²ä¿å­˜çš„ç›®æ ‡åœ°å€
            try {
                const saved = localStorage.getItem('model_test.target_url');
                if (saved) {
                    const input = document.getElementById('target-url');
                    if (input) input.value = saved;
                }
            } catch (e) { /* ignore storage errors */ }

            // åˆå§‹åŒ–è¿›åº¦æ ä¸ºæœªå¼€å§‹çŠ¶æ€
            updateProgressBar('ready');
            
            // ç«‹å³æ£€æŸ¥çŠ¶æ€å¹¶æ¢å¤
            checkStatus().then((status) => {
                // æ›´æ–°åˆå§‹æ¶ˆæ¯
                const initialMessage = document.getElementById('initial-message');
                if (status.is_running) {
                    // å­˜åœ¨æ­£åœ¨è¿›è¡Œçš„è¯„ä¼°ï¼Œç¡®ä¿å¯ä»¥ç»§ç»­æ‰“å°
                    window.__output_finalized__ = false;
                    initialMessage.textContent = 'ğŸ”„ æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„è¯„ä¼°ï¼Œæ­£åœ¨æ¢å¤çŠ¶æ€...';
                    addOutput('ğŸ”„ æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„è¯„ä¼°ï¼Œæ­£åœ¨æ¢å¤çŠ¶æ€...');
                    startStreaming();
                } else if (status.progress_status === 'completed') {
                    initialMessage.textContent = 'âœ… è¯„ä¼°å·²å®Œæˆï¼ŒæŠ¥å‘Šå·²è‡ªåŠ¨ä¿å­˜';
                } else {
                    initialMessage.textContent = 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…å¼€å§‹è¯„ä¼°...';
                }
            }).catch(() => {
                // å¦‚æœçŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œä¿æŒé»˜è®¤æ¶ˆæ¯
                console.log('çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯');
            });
            
            setInterval(checkStatus, 2000); // æ¯2ç§’æ£€æŸ¥çŠ¶æ€
            setInterval(monitorPageHeight, 1000); // æ¯ç§’ç›‘æ§é¡µé¢é«˜åº¦
        });

        // å¼€å§‹è¯„ä¼°
        async function startEvaluation() {
            const targetUrl = document.getElementById('target-url').value;
            const testMode = document.getElementById('test-mode').value;

            if (!targetUrl.trim()) {
                alert('è¯·è¾“å…¥ç›®æ ‡æ¨¡å‹åœ°å€');
                return;
            }

            try {
                // æŒä¹…åŒ–ä¿å­˜æœ¬æ¬¡ä½¿ç”¨çš„ç›®æ ‡åœ°å€
                try { localStorage.setItem('model_test.target_url', targetUrl); } catch (e) {}
                const response = await fetch('/start_evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_url: targetUrl,
                        test_mode: testMode
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    isRunning = true;
                    updateUI();
                    // æ–°ä¸€è½®è¯„ä¼°ï¼šå…è®¸ç»§ç»­æ‰“å°ï¼Œå¹¶æ¸…ç©ºæ—§è¾“å‡º
                    window.__output_finalized__ = false;
                    const container = document.getElementById('output-container');
                    if (container) container.innerHTML = '';
                    startStreaming();
                    addOutput('âœ… è¯„ä¼°å·²å¼€å§‹...');
                } else {
                    alert('å¯åŠ¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢è¯„ä¼°
        async function stopEvaluation() {
            try {
                const response = await fetch('/stop_evaluation', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    isRunning = false;
                    updateUI();
                    addOutput('ğŸ›‘ è¯„ä¼°å·²åœæ­¢');
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } else {
                    alert('åœæ­¢å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('åœæ­¢å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½å·²ç§»é™¤

        // å¼€å§‹æµå¼è¾“å‡º
        function startStreaming() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/stream_output');
            
            eventSource.onmessage = function(event) {
                if (!window.__output_finalized__) {
                    addOutput(event.data);
                }
            };

            eventSource.onerror = function(event) {
                console.error('EventSource failed:', event);
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }

        // æ·»åŠ è¾“å‡º
        function addOutput(message) {
            try {
                const container = document.getElementById('output-container');
                if (!container) return;
                
                // é˜²æ­¢é‡å¤æ¶ˆæ¯å’Œè¿‡é•¿æ¶ˆæ¯
                const lastLine = container.lastElementChild;
                if (lastLine && lastLine.textContent === message) {
                    return;
                }
                
                // é™åˆ¶å•æ¡æ¶ˆæ¯é•¿åº¦
                const maxMessageLength = 200;
                let displayMessage = message;
                if (message.length > maxMessageLength) {
                    displayMessage = message.substring(0, maxMessageLength) + '...';
                }
                
                const line = document.createElement('div');
                line.className = 'output-line';
                line.textContent = displayMessage;
                container.appendChild(line);
                
                // ä¸¥æ ¼é™åˆ¶æœ€å¤§è¡Œæ•°ï¼Œé˜²æ­¢æ— é™å¢é•¿
                const maxLines = 50; // å‡å°‘åˆ°50è¡Œ
                while (container.children.length > maxLines) {
                    container.removeChild(container.firstChild);
                }
                
                // é˜²æ­¢å®¹å™¨è¶…å‡ºå›ºå®šé«˜åº¦
                container.scrollTop = container.scrollHeight;
                
                // å¼ºåˆ¶æ£€æŸ¥å¹¶æ¸…ç†å¤šä½™å†…å®¹
                requestAnimationFrame(() => {
                    if (container.scrollHeight > container.clientHeight * 3) {
                        // å¦‚æœå†…å®¹è¿‡å¤šï¼Œå¼ºåˆ¶æ¸…ç†ä¸€åŠ
                        const children = Array.from(container.children);
                        const halfPoint = Math.floor(children.length / 2);
                        for (let i = 0; i < halfPoint; i++) {
                            if (container.firstChild) {
                                container.removeChild(container.firstChild);
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error in addOutput:', error);
            }
        }

        // ç»ˆæ­¢è¾“å‡ºå¹¶å†™å…¥æœ€åä¸€æ¬¡æ—¶é—´ç ä¸â€œè¯„ä¼°å®Œæˆâ€
        function finalizeOutput() {
            try {
                window.__output_finalized__ = true;
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                const container = document.getElementById('output-container');
                if (!container) return;
                const lastLine = container.lastElementChild;
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                if (lastLine) {
                    const timeNote = document.createElement('div');
                    timeNote.className = 'output-line';
                    timeNote.textContent = `[${timestamp}] è¯„ä¼°å®Œæˆï¼Œè¯·å‰å¾€æŠ¥å‘Šåˆ†æé¡µé¢æŸ¥çœ‹å…·ä½“å†…å®¹`;
                    container.appendChild(timeNote);
                } else {
                    const note = document.createElement('div');
                    note.className = 'output-line';
                    note.textContent = `[${timestamp}] è¯„ä¼°å®Œæˆï¼Œè¯·å‰å¾€æŠ¥å‘Šåˆ†æé¡µé¢æŸ¥çœ‹å…·ä½“å†…å®¹`;
                    container.appendChild(note);
                }
            } catch (e) {
                console.error('finalizeOutput failed:', e);
            }
        }

        // æ›´æ–°çº¿æ€§è¿›åº¦ï¼ˆ0-100%ï¼‰
        function updateProgressBar(status) {
            const termFill = document.getElementById('terminal-progress-fill');
            if (!termFill) return;
            if (status === 'ready') {
                termFill.style.width = '0%';
                hideDetailedProgress();
            } else if (status === 'running') {
                // å®é™…ç™¾åˆ†æ¯”ç”± checkStatus ä¸­çš„ time_progress_percent é©±åŠ¨
                showDetailedProgress();
            } else if (status === 'completed') {
                termFill.style.width = '100%';
                hideDetailedProgress();
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†è¿›åº¦æ¡
        function showDetailedProgress() {
            const detailedProgress = document.getElementById('detailed-progress');
            if (detailedProgress) {
                detailedProgress.style.display = 'block';
            }
        }

        // éšè—è¯¦ç»†è¿›åº¦æ¡
        function hideDetailedProgress() {
            const detailedProgress = document.getElementById('detailed-progress');
            if (detailedProgress) {
                detailedProgress.style.display = 'none';
            }
        }

        // ä¸æ»‘æ¨è¿›æ€»ä½“è¿›åº¦åˆ°ç›®æ ‡ç™¾åˆ†æ¯”
        let currentSmoothPercent = 0;
        let smoothTimer = null;
        function smoothProgressTo(targetPercent) {
            targetPercent = Math.max(0, Math.min(100, targetPercent));
            const bar = document.getElementById('terminal-progress-fill');
            if (!bar) return;

            // è‹¥é¦–æ¬¡è¿è¡Œï¼Œç”¨å½“å‰å®½åº¦è§£æèµ·ç‚¹
            const currentWidth = parseFloat(bar.style.width || '0');
            if (!isNaN(currentWidth)) currentSmoothPercent = currentWidth;

            const step = () => {
                const diff = targetPercent - currentSmoothPercent;
                if (Math.abs(diff) < 0.2) {
                    currentSmoothPercent = targetPercent;
                    bar.style.width = `${currentSmoothPercent.toFixed(1)}%`;
                    updateTerminalProgressText(currentSmoothPercent);
                    cancelAnimationFrame(smoothTimer);
                    smoothTimer = null;
                    return;
                }
                // æ¯å¸§ç¼“åŠ¨å‰è¿›ä¸€å°æ®µ
                currentSmoothPercent += diff * 0.08; // ç¼“åŠ¨ç³»æ•°
                bar.style.width = `${currentSmoothPercent.toFixed(1)}%`;
                updateTerminalProgressText(currentSmoothPercent);
                smoothTimer = requestAnimationFrame(step);
            };

            if (!smoothTimer) smoothTimer = requestAnimationFrame(step);
        }

        function formatHMS(sec) {
            sec = Math.max(0, Math.floor(sec));
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            const pad = (n) => n.toString().padStart(2, '0');
            if (h > 0) return `${pad(h)}:${pad(m)}:${pad(s)}`;
            return `${pad(m)}:${pad(s)}`;
        }

        // æ›´æ–°ç»ˆç«¯é£æ ¼æ–‡æœ¬: å·¦ä¾§ç™¾åˆ†æ¯”ï¼Œå³ä¾§ä¸º [å·²ç”¨<å‰©ä½™, é€Ÿç‡]
        function updateTerminalProgressText(percent) {
            const left = document.getElementById('terminal-progress-left');
            const right = document.getElementById('terminal-progress-right');
            const now = Date.now();
            try {
                // ä¼°ç®—ç”¨æ—¶ä¸å‰©ä½™ï¼šä¾èµ– evaluation_state.delay_start_time å’Œ delay_total_seconds
                if (window.__last_status__) {
                    const startISO = window.__last_status__.delay_start_time;
                    const totalSec = window.__last_status__.delay_total_seconds || 0;
                    let elapsed = 0;
                    if (startISO) {
                        const startMs = new Date(startISO).getTime();
                        elapsed = Math.max(0, Math.floor((now - startMs) / 1000));
                    }
                    const remain = Math.max(0, Math.floor(totalSec - elapsed));
                    // ä½¿ç”¨å®é™…æ—¶é—´æ¨å¯¼å½“å‰ç™¾åˆ†æ¯”ï¼Œé¿å…ä¸å¹³æ»‘åŠ¨ç”»åå·®
                    const percentNow = totalSec > 0 ? Math.min(100, (elapsed / totalSec) * 100) : percent;
                    // é€Ÿç‡æŒ‰æ€»æ—¶é•¿æ’å®š: 100% / totalSec
                    const rate = totalSec > 0 ? (100 / totalSec) : 0; // %/s
                    const rateText = `${rate.toFixed(2)}%/s`;
                    if (left) left.textContent = `${percentNow.toFixed(1)}%`;
                    if (right) right.textContent = `[${formatHMS(elapsed)}<${formatHMS(remain)}, ${rateText}]`;
                    return;
                }
            } catch (_) {}
            if (left) left.textContent = `${percent.toFixed(1)}%`;
            if (right) right.textContent = `[00:00<00:00, 0.00%/s]`;
        }

        // æ›´æ–°è¯¦ç»†æµ‹è¯•è¿›åº¦
        function updateDetailedProgress(currentTest, completedTests, totalTests) {
            const progressFill = document.getElementById('test-progress-fill');
            const testSteps = document.querySelectorAll('.test-step');
            
            if (!progressFill || !testSteps.length) return;
            
            // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
            const progressPercent = (completedTests / totalTests) * 100;
            progressFill.style.width = `${progressPercent}%`;
            
            // é‡ç½®æ‰€æœ‰æµ‹è¯•æ­¥éª¤
            testSteps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // æ ¹æ®å½“å‰æµ‹è¯•æ›´æ–°æ­¥éª¤çŠ¶æ€
            const testStepMap = {
                'å¥åº·æ£€æŸ¥': 1,
                'å¯¹è¯æµ‹è¯•': 2,
                'åŠŸèƒ½æµ‹è¯•': 2,
                'å®‰å…¨æµ‹è¯•': 3,
                'æ€§èƒ½æµ‹è¯•': 4,
                'åè§æµ‹è¯•': 5,
                'éšç§æµ‹è¯•': 6,
                'æŠ¥å‘Šç”Ÿæˆ': 7,
                'æŠ¥å‘Šè¾“å‡º': 7
            };
            
            const currentStepIndex = testStepMap[currentTest] || 0;
            
            // æ ‡è®°å·²å®Œæˆçš„æ­¥éª¤
            for (let i = 1; i < currentStepIndex; i++) {
                const step = document.getElementById(`test-step-${i}`);
                if (step) {
                    step.classList.add('completed');
                }
            }
            
            // æ ‡è®°å½“å‰æ­¥éª¤
            if (currentStepIndex > 0) {
                const currentStep = document.getElementById(`test-step-${currentStepIndex}`);
                if (currentStep) {
                    currentStep.classList.add('active');
                }
            }
        }

        // æ£€æŸ¥çŠ¶æ€
        async function checkStatus() {
            try {
                const response = await fetch('/get_status');
                const status = await response.json();
                
                // æ›´æ–°è¿è¡ŒçŠ¶æ€
                const wasRunning = isRunning;
                if (status.is_running !== isRunning) {
                    isRunning = status.is_running;
                    updateUI();
                    
                    if (!isRunning && status.completed_tests > 0) {
                        // è¯„ä¼°å®Œæˆï¼Œè·å–ç»“æœ
                        loadResults();
                    }
                }

                // ç¼“å­˜çŠ¶æ€ç»™è¿›åº¦æ¡æ–‡æœ¬ä¼°ç®—
                window.__last_status__ = status;

                // æ›´æ–°æ€»ä½“çº¿æ€§è¿›åº¦ï¼ˆä¸æ»‘åŠ¨ç”»ï¼‰
                updateProgressBar(status.progress_status);
                if (status.progress_status === 'running' && typeof status.time_progress_percent === 'number') {
                    smoothProgressTo(status.time_progress_percent);
                }
                
                // æ›´æ–°è¿›åº¦è¯¦æƒ…ï¼ˆä»…æ¡å½¢è¿›åº¦ï¼‰
                if (status.is_running && typeof status.time_progress_percent === 'number') {
                    smoothProgressTo(status.time_progress_percent);
                } else if (status.progress_status === 'completed') {
                    smoothProgressTo(100);
                } else {
                    smoothProgressTo(0);
                }

                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆä¸å†æ˜¾ç¤ºå…·ä½“æµ‹è¯•åç§°/è¿›åº¦ï¼‰
                const statusText = document.getElementById('status-text');
                const statusDot = document.getElementById('status-dot');
                if (status.is_running) {
                    statusText.textContent = 'è¯„ä¼°è¿›è¡Œä¸­...';
                    statusDot.classList.add('running');
                } else if (status.progress_status === 'completed') {
                    statusText.textContent = 'è¯„ä¼°å·²å®Œæˆ';
                    statusDot.classList.remove('running');
                    // ä»…å½“æ­£å¸¸å®Œæˆæ—¶æ‰è¾“å‡ºâ€œè¯„ä¼°å®Œæˆ...â€
                    if (status.completion_reason === 'success') {
                        if (!window.__output_finalized__) {
                            finalizeOutput();
                        }
                    } else {
                        // å¼‚å¸¸æˆ–æ‰‹åŠ¨åœæ­¢ï¼Œä¸åšé¢å¤–æ’å…¥
                        window.__output_finalized__ = true;
                        if (eventSource) { eventSource.close(); eventSource = null; }
                    }
                } else {
                    statusText.textContent = 'å°±ç»ª';
                    statusDot.classList.remove('running');
                }

                return status;
            } catch (error) {
                console.error('Status check failed:', error);
                throw error;
            }
        }

        // åŠ è½½ç»“æœ
        async function loadResults() {
            try {
                const response = await fetch('/get_results');
                const data = await response.json();
                
                if (data.overall && data.results) {
                    displayResults(data);
                }
            } catch (error) {
                console.error('Failed to load results:', error);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const resultsSection = document.getElementById('results-section');
            // å›¾äºŒæ¨¡å—ä¸å†æ˜¾ç¤º
            resultsSection.style.display = 'none';

            // ç»“æœåŒºåŸŸéšè—ï¼Œä¸å†æ¸²æŸ“æ€»ä½“ç­‰çº§ä¸åˆ†æ•°

            // æ˜¾ç¤ºåˆ†é¡¹å¾—åˆ†
            // ä¸æ¸²æŸ“åˆ†é¡¹å¾—åˆ†

            // æ˜¾ç¤ºå›¾è¡¨
            // ä¸æ¸²æŸ“å›¾è¡¨

            // æ˜¾ç¤ºæ¼æ´
            // ä¸æ¸²æŸ“æ¼æ´åˆ—è¡¨
        }

        // æ˜¾ç¤ºåˆ†æ•°å¡ç‰‡
        function displayScoreCards(scores) {
            const container = document.getElementById('score-display');
            container.innerHTML = '';

            const categories = {
                'functionality': 'ä¼ä¸šé‡‘èåŠŸèƒ½',
                'security': 'ä¼ä¸šé‡‘èå®‰å…¨',
                'performance': 'ä¼ä¸šé‡‘èæ€§èƒ½',
                'bias': 'åè§æ£€æµ‹',
                'privacy': 'éšç§ä¿æŠ¤'
            };

            for (const [key, value] of Object.entries(scores)) {
                const card = document.createElement('div');
                card.className = 'score-card';
                card.innerHTML = `
                    <div class="score-value">${value.toFixed(1)}</div>
                    <div class="score-label">${categories[key] || key}</div>
                `;
                container.appendChild(card);
            }
        }

        // æ˜¾ç¤ºå›¾è¡¨
        function displayChart(scores) {
            try {
                const canvas = document.getElementById('score-chart');
                if (!canvas) return;
                
                // å¼ºåˆ¶è®¾ç½®canvaså°ºå¯¸ï¼Œé˜²æ­¢æ— é™æ‰©å±•
                canvas.style.width = '100%';
                canvas.style.height = '300px';
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '300px';
                canvas.width = 400;
                canvas.height = 300;
                
                const ctx = canvas.getContext('2d');
                
                // æ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
                if (window.chartInstance) {
                    window.chartInstance.destroy();
                }
                
                const categories = {
                    'functionality': 'åŠŸèƒ½æ€§',
                    'security': 'å®‰å…¨æ€§', 
                    'performance': 'æ€§èƒ½',
                    'bias': 'åè§æ£€æµ‹',
                    'privacy': 'éšç§ä¿æŠ¤'
                };

                const labels = Object.keys(scores).map(key => categories[key] || key);
                const values = Object.values(scores);

                window.chartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'è¯„åˆ†',
                            data: values,
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: false,  // ç¦ç”¨å“åº”å¼è°ƒæ•´
                        maintainAspectRatio: false,
                        layout: {
                            padding: 10
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    circular: true
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // å¼ºåˆ¶é™åˆ¶å›¾è¡¨å°ºå¯¸
                setTimeout(() => {
                    if (window.chartInstance && window.chartInstance.canvas) {
                        window.chartInstance.canvas.style.width = '100%';
                        window.chartInstance.canvas.style.height = '300px';
                        window.chartInstance.canvas.style.maxWidth = '100%';
                        window.chartInstance.canvas.style.maxHeight = '300px';
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error creating chart:', error);
                // å¦‚æœå›¾è¡¨åˆ›å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºç®€å•çš„æ–‡æœ¬
                const container = document.querySelector('.chart-container');
                if (container) {
                    container.innerHTML = '<h3>ğŸ“ˆ è¯¦ç»†åˆ†æ</h3><p>å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                }
            }
        }

        // æ˜¾ç¤ºæ¼æ´
        function displayVulnerabilities(results) {
            const container = document.getElementById('vulnerabilities-list');
            container.innerHTML = '';

            let allVulnerabilities = [];
            results.forEach(result => {
                if (result.vulnerabilities) {
                    result.vulnerabilities.forEach(vuln => {
                        allVulnerabilities.push(`[${result.category}] ${vuln}`);
                    });
                }
            });

            if (allVulnerabilities.length === 0) {
                container.innerHTML = '<div class="vulnerability-item">âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜</div>';
            } else {
                // é™åˆ¶æœ€å¤§æ¼æ´æ˜¾ç¤ºæ•°é‡ï¼Œé˜²æ­¢é¡µé¢è¿‡é•¿
                const maxVulns = 20;
                const limitedVulns = allVulnerabilities.slice(0, maxVulns);
                
                limitedVulns.forEach(vuln => {
                    const item = document.createElement('div');
                    item.className = 'vulnerability-item';
                    item.textContent = vuln;
                    container.appendChild(item);
                });
                
                if (allVulnerabilities.length > maxVulns) {
                    const moreItem = document.createElement('div');
                    moreItem.className = 'vulnerability-item';
                    moreItem.style.fontStyle = 'italic';
                    moreItem.style.color = '#666';
                    moreItem.textContent = `... è¿˜æœ‰ ${allVulnerabilities.length - maxVulns} ä¸ªé—®é¢˜æœªæ˜¾ç¤º`;
                    container.appendChild(moreItem);
                }
            }
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const startText = document.getElementById('start-text');
            const startLoading = document.getElementById('start-loading');

            if (isRunning) {
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                if (startText) startText.classList.add('hidden');
                if (startLoading) startLoading.classList.remove('hidden');
            } else {
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                if (startText) startText.classList.remove('hidden');
                if (startLoading) startLoading.classList.add('hidden');
            }
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­EventSource
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>

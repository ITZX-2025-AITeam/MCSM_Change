<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模型综合评测系统</title>
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: #f6f8fa;
            min-height: 100vh;
            color: #24292f;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #24292f;
            margin-bottom: 30px;
            padding: 40px 0 20px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            color: #24292f;
        }

        .header p {
            font-size: 1.2em;
            color: #656d76;
        }

        .main-panel {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04), 0 1px 0 rgba(255,255,255,0.25);
            padding: 24px;
            margin-bottom: 20px;
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
            background-color: #ffffff;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9,105,218,0.3);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            min-width: 120px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #0969da;
            color: white;
            border-color: #0969da;
        }

        .btn-primary:hover {
            background-color: #0858b9;
            border-color: #0858b9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #cf222e;
            color: white;
            border-color: #cf222e;
        }

        .btn-danger:hover {
            background-color: #a91e2a;
            border-color: #a91e2a;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: #2da44e;
            color: white;
            border-color: #2da44e;
        }

        .btn-success:hover {
            background-color: #2c974b;
            border-color: #2c974b;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-section {
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #24292f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-header h3 {
            color: #24292f;
            margin: 0;
        }

        .progress-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .current-test {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-count {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .progress-step.active:not(:last-child)::after {
            background: #4ade80;
        }

        .progress-step.completed:not(:last-child)::after {
            background: #4ade80;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-icon {
            background: #4ade80;
            transform: scale(1.1);
        }

        .progress-step.completed .step-icon {
            background: #4ade80;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-step.active .step-label {
            color: white;
            font-weight: 600;
        }

        .progress-step.completed .step-label {
            color: white;
            font-weight: 600;
        }

        /* 终端风格进度条 */
        .terminal-progress {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            height: 24px;
            position: relative;
            overflow: hidden;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: #c9d1d9;
        }
        .terminal-progress-fill {
            background: #238636;
            height: 100%;
            width: 0%;
            transition: width 0.1s linear;
        }
        .terminal-progress-label {
            position: absolute;
            left: 8px;
            right: 8px;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #c9d1d9;
            pointer-events: none;
        }

        .status-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.running {
            background: #28a745;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        .output-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #374151;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            border: 1px solid #d1d5db;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .output-line {
            margin-bottom: 5px;
            padding: 2px 0;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .results-section {
            display: none;
            margin-top: 20px;
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            border-left: 4px solid #0969da;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04);
            transition: transform 0.15s ease-in-out;
        }

        .score-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(27,31,36,0.1);
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #0969da;
            margin-bottom: 5px;
        }

        .score-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grade-display {
            background: #0969da;
            color: white;
            border-radius: 6px;
            padding: 24px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #0969da;
        }

        .grade-letter {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .grade-text {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(27,31,36,0.04);
            height: 400px;
            max-height: 400px;
            overflow: hidden;
            position: relative;
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 350px !important;
            width: auto !important;
            height: auto !important;
        }

        .vulnerabilities-section {
            background: #fff8dc;
            border: 1px solid #f0c674;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .vulnerability-item {
            background: white;
            border-left: 4px solid #cf222e;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            word-wrap: break-word;
            max-width: 100%;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .control-section {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .score-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔬 模型综合评测系统</h1>
            <p>基于 Hugging Face 标准的AI模型黑箱测试平台</p>
        </div>

        <div class="main-panel">
            <div class="control-section">
                <div class="input-group">
                    <label for="target-url">目标模型地址</label>
                    <input type="text" id="target-url" value="192.168.1.101:5001" placeholder="IP:端口">
                </div>
                <div class="input-group">
                    <label for="test-mode">测试模式</label>
                    <select id="test-mode">
                        <option value="comprehensive">综合测试</option>
                        <option value="security">安全性专项</option>
                        <option value="performance">性能专项</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="start-btn" onclick="startEvaluation()">
                    <span id="start-text">🚀 开始评估</span>
                    <span id="start-loading" class="loading hidden"></span>
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopEvaluation()" disabled>
                    ⏹️ 停止评估
                </button>
                <!-- 下载按钮移除：报告将自动保存至 /root/server/MCSManager/report -->
                <button class="btn" style="background-color: #656d76; border-color: #656d76; color: white;" onclick="window.location.href='/offline_test'">
                    🔧 离线测试
                </button>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <h3>🚀 评估进度</h3>
                </div>
                
                <!-- 终端风格进度条（0-100%） -->
                <div class="terminal-progress" id="terminal-progress">
                    <div class="terminal-progress-fill" id="terminal-progress-fill"></div>
                    <div class="terminal-progress-label">
                        <span id="terminal-progress-left">0%</span>
                        <span id="terminal-progress-right">[00:00<00:00, 0.00%/s]</span>
                    </div>
                </div>
                
                <!-- 详细测试进度条移除：仅保留总体线性进度条 -->
            </div>

            <div class="status-section">
                <div class="status-header">
                    <h3>📊 评估状态</h3>
                    <div class="status-indicator">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">就绪</span>
                    </div>
                </div>
                <div class="output-container" id="output-container">
                    <div class="output-line" id="initial-message">系统初始化完成，等待开始评估...</div>
                </div>
            </div>

            <div class="results-section" id="results-section">
                <div class="grade-display" id="grade-display">
                    <div class="grade-letter" id="grade-letter">-</div>
                    <div class="grade-text" id="grade-text">等待评估结果</div>
                </div>

                <div class="score-display" id="score-display">
                    <!-- 分数卡片将通过JavaScript动态生成 -->
                </div>

                <div class="chart-container">
                    <h3>📈 详细分析</h3>
                    <canvas id="score-chart" width="400" height="200"></canvas>
                </div>

                <div class="vulnerabilities-section" id="vulnerabilities-section">
                    <h3>⚠️ 发现的问题</h3>
                    <div id="vulnerabilities-list">
                        <!-- 漏洞列表将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 输出结束标记：每次新评估开始前需要复位为 false
        window.__output_finalized__ = false;
        let eventSource = null;
        let isRunning = false;
        let statusCheckInterval = null;

        // 页面高度监控和清理
        function monitorPageHeight() {
            const body = document.body;
            const maxHeight = window.innerHeight * 5; // 最多允许5个屏幕高度
            
            if (body.scrollHeight > maxHeight) {
                console.log('页面过高，进行清理');
                
                // 清理输出容器
                const container = document.getElementById('output-container');
                if (container && container.children.length > 10) {
                    const children = Array.from(container.children);
                    const keepCount = 10;
                    for (let i = 0; i < children.length - keepCount; i++) {
                        container.removeChild(children[i]);
                    }
                }
                
                // 清理漏洞列表
                const vulnList = document.getElementById('vulnerabilities-list');
                if (vulnList && vulnList.children.length > 10) {
                    const children = Array.from(vulnList.children);
                    const keepCount = 10;
                    for (let i = 0; i < children.length - keepCount; i++) {
                        vulnList.removeChild(children[i]);
                    }
                }
                
                // 强制回到页面顶部
                window.scrollTo(0, 0);
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 回填已保存的目标地址
            try {
                const saved = localStorage.getItem('model_test.target_url');
                if (saved) {
                    const input = document.getElementById('target-url');
                    if (input) input.value = saved;
                }
            } catch (e) { /* ignore storage errors */ }

            // 初始化进度栏为未开始状态
            updateProgressBar('ready');
            
            // 立即检查状态并恢复
            checkStatus().then((status) => {
                // 更新初始消息
                const initialMessage = document.getElementById('initial-message');
                if (status.is_running) {
                    // 存在正在进行的评估，确保可以继续打印
                    window.__output_finalized__ = false;
                    initialMessage.textContent = '🔄 检测到正在进行的评估，正在恢复状态...';
                    addOutput('🔄 检测到正在进行的评估，正在恢复状态...');
                    startStreaming();
                } else if (status.progress_status === 'completed') {
                    initialMessage.textContent = '✅ 评估已完成，报告已自动保存';
                } else {
                    initialMessage.textContent = '系统初始化完成，等待开始评估...';
                }
            }).catch(() => {
                // 如果状态检查失败，保持默认消息
                console.log('状态检查失败，使用默认消息');
            });
            
            setInterval(checkStatus, 2000); // 每2秒检查状态
            setInterval(monitorPageHeight, 1000); // 每秒监控页面高度
        });

        // 开始评估
        async function startEvaluation() {
            const targetUrl = document.getElementById('target-url').value;
            const testMode = document.getElementById('test-mode').value;

            if (!targetUrl.trim()) {
                alert('请输入目标模型地址');
                return;
            }

            try {
                // 持久化保存本次使用的目标地址
                try { localStorage.setItem('model_test.target_url', targetUrl); } catch (e) {}
                const response = await fetch('/start_evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_url: targetUrl,
                        test_mode: testMode
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    isRunning = true;
                    updateUI();
                    // 新一轮评估：允许继续打印，并清空旧输出
                    window.__output_finalized__ = false;
                    const container = document.getElementById('output-container');
                    if (container) container.innerHTML = '';
                    startStreaming();
                    addOutput('✅ 评估已开始...');
                } else {
                    alert('启动失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('启动失败: ' + error.message);
            }
        }

        // 停止评估
        async function stopEvaluation() {
            try {
                const response = await fetch('/stop_evaluation', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    isRunning = false;
                    updateUI();
                    addOutput('🛑 评估已停止');
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } else {
                    alert('停止失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('停止失败: ' + error.message);
            }
        }

        // 下载已移除

        // 开始流式输出
        function startStreaming() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/stream_output');
            
            eventSource.onmessage = function(event) {
                if (!window.__output_finalized__) {
                    addOutput(event.data);
                }
            };

            eventSource.onerror = function(event) {
                console.error('EventSource failed:', event);
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }

        // 添加输出
        function addOutput(message) {
            try {
                const container = document.getElementById('output-container');
                if (!container) return;
                
                // 防止重复消息和过长消息
                const lastLine = container.lastElementChild;
                if (lastLine && lastLine.textContent === message) {
                    return;
                }
                
                // 限制单条消息长度
                const maxMessageLength = 200;
                let displayMessage = message;
                if (message.length > maxMessageLength) {
                    displayMessage = message.substring(0, maxMessageLength) + '...';
                }
                
                const line = document.createElement('div');
                line.className = 'output-line';
                line.textContent = displayMessage;
                container.appendChild(line);
                
                // 严格限制最大行数，防止无限增长
                const maxLines = 50; // 减少到50行
                while (container.children.length > maxLines) {
                    container.removeChild(container.firstChild);
                }
                
                // 防止容器超出固定高度
                container.scrollTop = container.scrollHeight;
                
                // 强制检查并清理多余内容
                requestAnimationFrame(() => {
                    if (container.scrollHeight > container.clientHeight * 3) {
                        // 如果内容过多，强制清理一半
                        const children = Array.from(container.children);
                        const halfPoint = Math.floor(children.length / 2);
                        for (let i = 0; i < halfPoint; i++) {
                            if (container.firstChild) {
                                container.removeChild(container.firstChild);
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error in addOutput:', error);
            }
        }

        // 终止输出并写入最后一次时间码与“评估完成”
        function finalizeOutput() {
            try {
                window.__output_finalized__ = true;
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                const container = document.getElementById('output-container');
                if (!container) return;
                const lastLine = container.lastElementChild;
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                if (lastLine) {
                    const timeNote = document.createElement('div');
                    timeNote.className = 'output-line';
                    timeNote.textContent = `[${timestamp}] 评估完成，请前往报告分析页面查看具体内容`;
                    container.appendChild(timeNote);
                } else {
                    const note = document.createElement('div');
                    note.className = 'output-line';
                    note.textContent = `[${timestamp}] 评估完成，请前往报告分析页面查看具体内容`;
                    container.appendChild(note);
                }
            } catch (e) {
                console.error('finalizeOutput failed:', e);
            }
        }

        // 更新线性进度（0-100%）
        function updateProgressBar(status) {
            const termFill = document.getElementById('terminal-progress-fill');
            if (!termFill) return;
            if (status === 'ready') {
                termFill.style.width = '0%';
                hideDetailedProgress();
            } else if (status === 'running') {
                // 实际百分比由 checkStatus 中的 time_progress_percent 驱动
                showDetailedProgress();
            } else if (status === 'completed') {
                termFill.style.width = '100%';
                hideDetailedProgress();
            }
        }

        // 显示详细进度条
        function showDetailedProgress() {
            const detailedProgress = document.getElementById('detailed-progress');
            if (detailedProgress) {
                detailedProgress.style.display = 'block';
            }
        }

        // 隐藏详细进度条
        function hideDetailedProgress() {
            const detailedProgress = document.getElementById('detailed-progress');
            if (detailedProgress) {
                detailedProgress.style.display = 'none';
            }
        }

        // 丝滑推进总体进度到目标百分比
        let currentSmoothPercent = 0;
        let smoothTimer = null;
        function smoothProgressTo(targetPercent) {
            targetPercent = Math.max(0, Math.min(100, targetPercent));
            const bar = document.getElementById('terminal-progress-fill');
            if (!bar) return;

            // 若首次运行，用当前宽度解析起点
            const currentWidth = parseFloat(bar.style.width || '0');
            if (!isNaN(currentWidth)) currentSmoothPercent = currentWidth;

            const step = () => {
                const diff = targetPercent - currentSmoothPercent;
                if (Math.abs(diff) < 0.2) {
                    currentSmoothPercent = targetPercent;
                    bar.style.width = `${currentSmoothPercent.toFixed(1)}%`;
                    updateTerminalProgressText(currentSmoothPercent);
                    cancelAnimationFrame(smoothTimer);
                    smoothTimer = null;
                    return;
                }
                // 每帧缓动前进一小段
                currentSmoothPercent += diff * 0.08; // 缓动系数
                bar.style.width = `${currentSmoothPercent.toFixed(1)}%`;
                updateTerminalProgressText(currentSmoothPercent);
                smoothTimer = requestAnimationFrame(step);
            };

            if (!smoothTimer) smoothTimer = requestAnimationFrame(step);
        }

        function formatHMS(sec) {
            sec = Math.max(0, Math.floor(sec));
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            const pad = (n) => n.toString().padStart(2, '0');
            if (h > 0) return `${pad(h)}:${pad(m)}:${pad(s)}`;
            return `${pad(m)}:${pad(s)}`;
        }

        // 更新终端风格文本: 左侧百分比，右侧为 [已用<剩余, 速率]
        function updateTerminalProgressText(percent) {
            const left = document.getElementById('terminal-progress-left');
            const right = document.getElementById('terminal-progress-right');
            const now = Date.now();
            try {
                // 估算用时与剩余：依赖 evaluation_state.delay_start_time 和 delay_total_seconds
                if (window.__last_status__) {
                    const startISO = window.__last_status__.delay_start_time;
                    const totalSec = window.__last_status__.delay_total_seconds || 0;
                    let elapsed = 0;
                    if (startISO) {
                        const startMs = new Date(startISO).getTime();
                        elapsed = Math.max(0, Math.floor((now - startMs) / 1000));
                    }
                    const remain = Math.max(0, Math.floor(totalSec - elapsed));
                    // 使用实际时间推导当前百分比，避免与平滑动画偏差
                    const percentNow = totalSec > 0 ? Math.min(100, (elapsed / totalSec) * 100) : percent;
                    // 速率按总时长恒定: 100% / totalSec
                    const rate = totalSec > 0 ? (100 / totalSec) : 0; // %/s
                    const rateText = `${rate.toFixed(2)}%/s`;
                    if (left) left.textContent = `${percentNow.toFixed(1)}%`;
                    if (right) right.textContent = `[${formatHMS(elapsed)}<${formatHMS(remain)}, ${rateText}]`;
                    return;
                }
            } catch (_) {}
            if (left) left.textContent = `${percent.toFixed(1)}%`;
            if (right) right.textContent = `[00:00<00:00, 0.00%/s]`;
        }

        // 更新详细测试进度
        function updateDetailedProgress(currentTest, completedTests, totalTests) {
            const progressFill = document.getElementById('test-progress-fill');
            const testSteps = document.querySelectorAll('.test-step');
            
            if (!progressFill || !testSteps.length) return;
            
            // 计算进度百分比
            const progressPercent = (completedTests / totalTests) * 100;
            progressFill.style.width = `${progressPercent}%`;
            
            // 重置所有测试步骤
            testSteps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // 根据当前测试更新步骤状态
            const testStepMap = {
                '健康检查': 1,
                '对话测试': 2,
                '功能测试': 2,
                '安全测试': 3,
                '性能测试': 4,
                '偏见测试': 5,
                '隐私测试': 6,
                '报告生成': 7,
                '报告输出': 7
            };
            
            const currentStepIndex = testStepMap[currentTest] || 0;
            
            // 标记已完成的步骤
            for (let i = 1; i < currentStepIndex; i++) {
                const step = document.getElementById(`test-step-${i}`);
                if (step) {
                    step.classList.add('completed');
                }
            }
            
            // 标记当前步骤
            if (currentStepIndex > 0) {
                const currentStep = document.getElementById(`test-step-${currentStepIndex}`);
                if (currentStep) {
                    currentStep.classList.add('active');
                }
            }
        }

        // 检查状态
        async function checkStatus() {
            try {
                const response = await fetch('/get_status');
                const status = await response.json();
                
                // 更新运行状态
                const wasRunning = isRunning;
                if (status.is_running !== isRunning) {
                    isRunning = status.is_running;
                    updateUI();
                    
                    if (!isRunning && status.completed_tests > 0) {
                        // 评估完成，获取结果
                        loadResults();
                    }
                }

                // 缓存状态给进度条文本估算
                window.__last_status__ = status;

                // 更新总体线性进度（丝滑动画）
                updateProgressBar(status.progress_status);
                if (status.progress_status === 'running' && typeof status.time_progress_percent === 'number') {
                    smoothProgressTo(status.time_progress_percent);
                }
                
                // 更新进度详情（仅条形进度）
                if (status.is_running && typeof status.time_progress_percent === 'number') {
                    smoothProgressTo(status.time_progress_percent);
                } else if (status.progress_status === 'completed') {
                    smoothProgressTo(100);
                } else {
                    smoothProgressTo(0);
                }

                // 更新状态指示器（不再显示具体测试名称/进度）
                const statusText = document.getElementById('status-text');
                const statusDot = document.getElementById('status-dot');
                if (status.is_running) {
                    statusText.textContent = '评估进行中...';
                    statusDot.classList.add('running');
                } else if (status.progress_status === 'completed') {
                    statusText.textContent = '评估已完成';
                    statusDot.classList.remove('running');
                    // 仅当正常完成时才输出“评估完成...”
                    if (status.completion_reason === 'success') {
                        if (!window.__output_finalized__) {
                            finalizeOutput();
                        }
                    } else {
                        // 异常或手动停止，不做额外插入
                        window.__output_finalized__ = true;
                        if (eventSource) { eventSource.close(); eventSource = null; }
                    }
                } else {
                    statusText.textContent = '就绪';
                    statusDot.classList.remove('running');
                }

                return status;
            } catch (error) {
                console.error('Status check failed:', error);
                throw error;
            }
        }

        // 加载结果
        async function loadResults() {
            try {
                const response = await fetch('/get_results');
                const data = await response.json();
                
                if (data.overall && data.results) {
                    displayResults(data);
                }
            } catch (error) {
                console.error('Failed to load results:', error);
            }
        }

        // 显示结果
        function displayResults(data) {
            const resultsSection = document.getElementById('results-section');
            // 图二模块不再显示
            resultsSection.style.display = 'none';

            // 结果区域隐藏，不再渲染总体等级与分数

            // 显示分项得分
            // 不渲染分项得分

            // 显示图表
            // 不渲染图表

            // 显示漏洞
            // 不渲染漏洞列表
        }

        // 显示分数卡片
        function displayScoreCards(scores) {
            const container = document.getElementById('score-display');
            container.innerHTML = '';

            const categories = {
                'functionality': '企业金融功能',
                'security': '企业金融安全',
                'performance': '企业金融性能',
                'bias': '偏见检测',
                'privacy': '隐私保护'
            };

            for (const [key, value] of Object.entries(scores)) {
                const card = document.createElement('div');
                card.className = 'score-card';
                card.innerHTML = `
                    <div class="score-value">${value.toFixed(1)}</div>
                    <div class="score-label">${categories[key] || key}</div>
                `;
                container.appendChild(card);
            }
        }

        // 显示图表
        function displayChart(scores) {
            try {
                const canvas = document.getElementById('score-chart');
                if (!canvas) return;
                
                // 强制设置canvas尺寸，防止无限扩展
                canvas.style.width = '100%';
                canvas.style.height = '300px';
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '300px';
                canvas.width = 400;
                canvas.height = 300;
                
                const ctx = canvas.getContext('2d');
                
                // 清除之前的图表
                if (window.chartInstance) {
                    window.chartInstance.destroy();
                }
                
                const categories = {
                    'functionality': '功能性',
                    'security': '安全性', 
                    'performance': '性能',
                    'bias': '偏见检测',
                    'privacy': '隐私保护'
                };

                const labels = Object.keys(scores).map(key => categories[key] || key);
                const values = Object.values(scores);

                window.chartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '评分',
                            data: values,
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: false,  // 禁用响应式调整
                        maintainAspectRatio: false,
                        layout: {
                            padding: 10
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    circular: true
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // 强制限制图表尺寸
                setTimeout(() => {
                    if (window.chartInstance && window.chartInstance.canvas) {
                        window.chartInstance.canvas.style.width = '100%';
                        window.chartInstance.canvas.style.height = '300px';
                        window.chartInstance.canvas.style.maxWidth = '100%';
                        window.chartInstance.canvas.style.maxHeight = '300px';
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error creating chart:', error);
                // 如果图表创建失败，显示简单的文本
                const container = document.querySelector('.chart-container');
                if (container) {
                    container.innerHTML = '<h3>📈 详细分析</h3><p>图表加载失败，请刷新页面重试</p>';
                }
            }
        }

        // 显示漏洞
        function displayVulnerabilities(results) {
            const container = document.getElementById('vulnerabilities-list');
            container.innerHTML = '';

            let allVulnerabilities = [];
            results.forEach(result => {
                if (result.vulnerabilities) {
                    result.vulnerabilities.forEach(vuln => {
                        allVulnerabilities.push(`[${result.category}] ${vuln}`);
                    });
                }
            });

            if (allVulnerabilities.length === 0) {
                container.innerHTML = '<div class="vulnerability-item">✅ 未发现明显安全问题</div>';
            } else {
                // 限制最大漏洞显示数量，防止页面过长
                const maxVulns = 20;
                const limitedVulns = allVulnerabilities.slice(0, maxVulns);
                
                limitedVulns.forEach(vuln => {
                    const item = document.createElement('div');
                    item.className = 'vulnerability-item';
                    item.textContent = vuln;
                    container.appendChild(item);
                });
                
                if (allVulnerabilities.length > maxVulns) {
                    const moreItem = document.createElement('div');
                    moreItem.className = 'vulnerability-item';
                    moreItem.style.fontStyle = 'italic';
                    moreItem.style.color = '#666';
                    moreItem.textContent = `... 还有 ${allVulnerabilities.length - maxVulns} 个问题未显示`;
                    container.appendChild(moreItem);
                }
            }
        }

        // 更新UI状态
        function updateUI() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const startText = document.getElementById('start-text');
            const startLoading = document.getElementById('start-loading');

            if (isRunning) {
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                if (startText) startText.classList.add('hidden');
                if (startLoading) startLoading.classList.remove('hidden');
            } else {
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                if (startText) startText.classList.remove('hidden');
                if (startLoading) startLoading.classList.add('hidden');
            }
        }

        // 页面卸载时关闭EventSource
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
